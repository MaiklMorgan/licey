tinymce.PluginManager.add('imagegallery', function(editor, url) {
    editor.addButton('imagegallery', {
        text: 'Галерея',
        icon: false,
        onclick: function() {
            editor.windowManager.open({
                title: 'Добавить галерею',
                body: [
                    {
                        type:       'textbox',
                        subtype:    'file',
                        name:       'files', 
                        label:      'Изображения',
                        onclick:    function(e){
                            e.target.setAttribute('multiple', true);
                        }
                    },
                ],
                buttons: [
                    {
                        text: 'Вставить галерею',
                        classes: 'widget btn primary first abs-layout-item',
                        disabled: false,
                        onclick: function(){
                            var fileInput = document.getElementById(this.rootControl._id).querySelectorAll('[type="file"]')[0];

                            if(!fileInput.files.length) return;
                            var formData = new FormData();
                            var files = [];
                            var markup =  '';

                            Array.prototype.forEach.call(fileInput.files, function(file, i, arr) {
                                formData.append('images[]', file);
                            });

                            formData.append('images', files);

                            var xhr     = new XMLHttpRequest(),
                                method  = 'POST',
                                url     = '/tinymce/safe-gallery';

                            if("withCredentials" in xhr){
                                xhr.open(method, url, true);
                            }
                            else if(typeof XDomainRequest != "undefined"){
                                xhr = new XDomainRequest();
                                xhr.open(method, url);
                            }
                            else {
                                xhr = null;
                            }

                            if(xhr){
                                xhr.onreadystatechange = function() {
                                    if (xhr.readyState == XMLHttpRequest.DONE) {            
                                        if(xhr.status != 200){
                                            throw new Error(xhr.status + ': ' + xhr.statusText);
                                        }
                                        else{
                                            JSON.parse(xhr.responseText).forEach(function(name){
                                                markup += '<img class="mceNonEditable" src="/imagecache/1110x760/' + name + '" />'
                                            });

                                            editor.insertContent('<div class="owl-carousel owl-single-full-features owl-nav-outer mceNonEditable">' + markup + '</div>', {format: 'raw'});

                                            editor.windowManager.close();
                                        }
                                    }
                                }

                                xhr.send(formData);
                            }

                            return false;
                        }
                    },
                    {
                        text: 'Отмена',
                        onclick: 'close'
                    }
                ]
            });
        }
    });

    return {
        getMetadata: function () {
            return  {
                name: "Example plugin",
                url: "http://exampleplugindocsurl.com"
            };
        }
    };
});